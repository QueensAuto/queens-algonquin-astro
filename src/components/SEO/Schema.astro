---
/**
 * Schema.astro
 * Centralized JSON-LD Schema Generator for Queens Auto Service
 * Implements Advanced Nested Schema Tactics (Caleb Ulku Strategy)
 */
import type { BrandConfig } from "../../brands/types";
import allServicesData from "../../data/services.json";

interface Props {
    brand: BrandConfig;
    type?: "LocalBusiness" | "Service" | "FAQPage" | "WebSite";
    pageType?: string;
    title?: string;
    description?: string;
    url?: string;
    image?: string;
    serviceData?: any;
    faqData?: any;
    reviewData?: any[];
}

const {
    brand,
    type = "LocalBusiness",
    title,
    description,
    url,
    image,
    serviceData,
    faqData,
    reviewData,
} = Astro.props;

const canonicalUrl = url || `https://${brand.domain}${Astro.url.pathname}`;
const siteName = brand.name;
const isHomepage =
    Astro.url.pathname === "/" || Astro.url.pathname === "/index.html";

// 1. Organization Schema (Globally establishing E-E-A-T)
const organizationSchema = {
    "@context": "https://schema.org",
    "@type": "Organization",
    "@id": `https://${brand.domain}/#organization`,
    name: brand.name,
    url: `https://${brand.domain}`,
    logo: {
        "@type": "ImageObject",
        url: `https://${brand.domain}${brand.logoPath}`,
        width: "512",
        height: "512",
    },
    sameAs: [
        "https://www.facebook.com/p/Queens-Auto-Services-Algonquin-100076608098799/",
        "https://www.instagram.com/queens_auto_/",
        "https://x.com/queensalgonquin",
    ],
};

// 2. WebSite Schema
const websiteSchema = {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "@id": `https://${brand.domain}/#website`,
    url: `https://${brand.domain}`,
    name: siteName,
    publisher: {
        "@id": `https://${brand.domain}/#organization`,
    },
};

// 3. LocalBusiness Schema (HOMEPAGE ONLY - Nested Hack)
let localBusinessSchema = null;
if (isHomepage) {
    // Dynamically build Nested Services from services.json
    const homepageServices: any[] = [];
    allServicesData.forEach((category: any) => {
        category.services.forEach((service: any) => {
            homepageServices.push({
                "@type": "Offer",
                itemOffered: {
                    "@type": "Service",
                    name: service.title,
                    description: service.shortTitle || service.title,
                    url: `https://${brand.domain}/services/${category.slug}/${service.slug}`,
                },
            });
        });
    });

    localBusinessSchema = {
        "@context": "https://schema.org",
        "@type": "AutoRepair",
        "@id": `https://${brand.domain}/#localbusiness`,
        name: brand.name,
        url: `https://${brand.domain}`,
        logo: `https://${brand.domain}${brand.logoPath}`,
        image: `https://${brand.domain}/images/shop/Queens%20Auto%20Algonquin%20-%20Store%20Front.webp`,
        telephone: brand.phone,
        email: brand.email,
        address: {
            "@type": "PostalAddress",
            streetAddress: "2401 E Algonquin Rd",
            addressLocality: "Algonquin",
            addressRegion: "IL",
            postalCode: "60102",
            addressCountry: "US",
        },
        geo: {
            "@type": "GeoCoordinates",
            latitude: 42.150482,
            longitude: -88.2572252,
        },
        hasMap: brand.googleMapsUrl,
        openingHoursSpecification: [
            {
                "@type": "OpeningHoursSpecification",
                dayOfWeek: [
                    "Monday",
                    "Tuesday",
                    "Wednesday",
                    "Thursday",
                    "Friday",
                ],
                opens: "07:30",
                closes: "18:00",
            },
            {
                "@type": "OpeningHoursSpecification",
                dayOfWeek: "Saturday",
                opens: "07:30",
                closes: "16:00",
            },
        ],
        priceRange: "$$",
        aggregateRating: {
            "@type": "AggregateRating",
            ratingValue: "4.4",
            reviewCount: "188",
        },
        makesOffer: homepageServices,
        parentOrganization: {
            "@id": `https://${brand.domain}/#organization`,
        },
    };
}

// 4. Service Schema (For individual service pages)
let serviceSchema = null;
if (serviceData && !isHomepage) {
    serviceSchema = {
        "@context": "https://schema.org",
        "@type": "Service",
        serviceType: serviceData.title,
        provider: {
            "@id": `https://${brand.domain}/#organization`,
        },
        areaServed: {
            "@type": "City",
            name: "Algonquin",
            sameAs: "https://en.wikipedia.org/wiki/Algonquin,_Illinois",
        },
        description: serviceData.pitch || description,
        offers: {
            "@type": "Offer",
            availability: "https://schema.org/InStock",
            url: canonicalUrl,
        },
    };
}

// 5. FAQ Schema
let faqSchema = null;
if (faqData) {
    faqSchema = {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        mainEntity: faqData.map((faq: any) => ({
            "@type": "Question",
            name: faq.question,
            acceptedAnswer: {
                "@type": "Answer",
                text: faq.answer,
            },
        })),
    };
}

// 6. Review Schema
let reviewSchema = null;
if (reviewData && reviewData.length > 0) {
    reviewSchema = reviewData.map((review: any) => ({
        "@context": "https://schema.org",
        "@type": "Review",
        itemReviewed: {
            "@id": `https://${brand.domain}/#organization`,
        },
        reviewRating: {
            "@type": "Rating",
            ratingValue: review.stars.toString(),
            bestRating: "5",
        },
        author: {
            "@type": "Person",
            name: review.name,
        },
        reviewBody: review.text,
        publisher: {
            "@id": `https://${brand.domain}/#organization`,
        },
    }));
}
---

{/* Inject Global Schemas on Every Page */}
<script
    type="application/ld+json"
    set:html={JSON.stringify(organizationSchema)}
/>
<script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />

{/* Conditional Schemas */}
{
    isHomepage && localBusinessSchema && (
        <script
            type="application/ld+json"
            set:html={JSON.stringify(localBusinessSchema)}
        />
    )
}
{
    serviceSchema && (
        <script
            type="application/ld+json"
            set:html={JSON.stringify(serviceSchema)}
        />
    )
}
{
    faqSchema && (
        <script
            type="application/ld+json"
            set:html={JSON.stringify(faqSchema)}
        />
    )
}
{
    reviewSchema &&
        reviewSchema.map((review: any) => (
            <script
                type="application/ld+json"
                set:html={JSON.stringify(review)}
            />
        ))
}
