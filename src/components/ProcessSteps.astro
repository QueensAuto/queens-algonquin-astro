---
/**
 * ProcessSteps - Vertical Timeline Design
 * Simple, clean, premium - no z-index or pinning complexity
 */
import CtaButton from "./CtaButton.astro";
---

<section class="process-section" id="process-section">
    <!-- Section Header -->
    <div class="process-header site-canvas">
        <span class="process-eyebrow">â€” How It Works</span>
        <h2 class="process-main-title display-xl">
            YOUR SERVICE <br />
            <span class="text-queens-primary">EXPERIENCE</span>
        </h2>
        <p class="process-intro">
            From the moment you contact us to when you drive away, we make every
            step simple, transparent, and stress-free.
        </p>
    </div>

    <!-- Timeline Container -->
    <div class="timeline-container site-canvas">
        <!-- Step 1 -->
        <div class="timeline-item" data-step="1">
            <div class="timeline-marker">
                <div class="timeline-dot">01</div>
                <div class="timeline-line"></div>
            </div>
            <div class="timeline-content">
                <h3 class="timeline-title">Schedule Your Service</h3>
                <p class="timeline-desc">
                    Book your appointment <span class="text-accent">online</span
                    >
                    or give us a call. Choose the service you need and pick a time
                    that works for your schedule.
                    <span class="text-accent">Same-day appointments</span> often available.
                </p>
            </div>
        </div>

        <!-- Step 2 -->
        <div class="timeline-item" data-step="2">
            <div class="timeline-marker">
                <div class="timeline-dot">02</div>
                <div class="timeline-line"></div>
            </div>
            <div class="timeline-content">
                <h3 class="timeline-title">Vehicle Inspection</h3>
                <p class="timeline-desc">
                    Our <span class="text-accent">certified technicians</span> perform
                    a thorough diagnostic of your vehicle. We identify exactly what
                    needs attention and document everything with <span
                        class="text-accent">photos and video</span
                    >.
                </p>
            </div>
        </div>

        <!-- Step 3 -->
        <div class="timeline-item" data-step="3">
            <div class="timeline-marker">
                <div class="timeline-dot">03</div>
                <div class="timeline-line"></div>
            </div>
            <div class="timeline-content">
                <h3 class="timeline-title">Transparent Quote</h3>
                <p class="timeline-desc">
                    Receive a <span class="text-accent">detailed estimate</span> with
                    no hidden fees. We explain every repair, show you the parts needed,
                    and get your
                    <span class="text-accent"
                        >approval before any work begins</span
                    >.
                </p>
            </div>
        </div>

        <!-- Step 4 -->
        <div class="timeline-item" data-step="4">
            <div class="timeline-marker">
                <div class="timeline-dot">04</div>
                <div class="timeline-line timeline-line-last"></div>
            </div>
            <div class="timeline-content">
                <h3 class="timeline-title">Expert Repair</h3>
                <p class="timeline-desc">
                    Skilled mechanics complete your repairs using <span
                        class="text-accent">quality parts</span
                    >. Every job is backed by our <span class="text-accent"
                        >24-month / 24,000-mile warranty</span
                    >. Get back on the road with confidence.
                </p>
            </div>
        </div>

        <!-- CTA -->
        <div class="timeline-cta">
            <CtaButton
                href="/request-an-appointment"
                text="Schedule Service Now"
                variant="standard"
            />
        </div>
    </div>
</section>

<style>
    .process-section {
        --section-bg: transparent;
        --card-bg: #ffffff;
        --card-border: rgba(0, 0, 0, 0.08);
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --accent: #0a79c8;
        --accent-light: rgba(10, 121, 200, 0.15);
        --timeline-line: rgba(0, 0, 0, 0.1);

        background: var(--section-bg);
        padding: 6rem 1.5rem 2rem;
    }

    :global(.dark) .process-section {
        --section-bg: transparent;
        --card-bg: rgba(255, 255, 255, 0.03);
        --card-border: rgba(255, 255, 255, 0.08);
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --accent: #0a79c8;
        --accent-light: rgba(10, 121, 200, 0.15);
        --timeline-line: rgba(255, 255, 255, 0.1);
    }

    @media (max-width: 640px) {
        .process-section {
            padding: 4rem 1rem 2rem; /* Reduced side padding from 1.5rem to 1rem */
        }
    }

    /* Section Header */
    .process-header {
        text-align: center;
        margin-bottom: 5rem;
    }

    @media (max-width: 640px) {
        .process-header {
            margin-bottom: 3rem;
        }
    }

    .process-eyebrow {
        display: inline-block;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        color: var(--accent);
        margin-bottom: 1rem;
    }

    .process-main-title {
        color: var(--text-primary);
        margin: 0 0 1.5rem;
    }

    .process-intro {
        font-size: 1.125rem;
        color: var(--text-secondary);
        line-height: 1.7;
        max-width: 600px;
        margin: 0 auto;
    }

    /* Timeline Container */
    .timeline-container {
        max-width: 900px;
        margin: 0 auto;
    }

    /* Timeline Item */
    .timeline-item {
        display: grid;
        grid-template-columns: 80px 1fr;
        gap: 2rem;
        margin-bottom: 3rem;
        opacity: 0;
        transform: translateY(30px);
    }

    @media (max-width: 640px) {
        .timeline-item {
            grid-template-columns: 48px 1fr; /* Reduced marker column width */
            gap: 1rem; /* Reduced gap */
            margin-bottom: 2rem;
        }
    }

    /* Timeline Marker */
    .timeline-marker {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
    }

    .timeline-dot {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #cbd5e1;
        color: #94a3b8;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        font-weight: 700;
        box-shadow: 0 0 0 8px rgba(203, 213, 225, 0.2);
        flex-shrink: 0;
        transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    :global(.dark) .timeline-dot {
        background: #334155;
        color: #64748b;
        box-shadow: 0 0 0 8px rgba(51, 65, 85, 0.3);
    }

    .timeline-dot.active {
        background: var(--accent);
        color: #ffffff;
        box-shadow:
            0 0 0 8px var(--accent-light),
            0 0 20px rgba(10, 121, 200, 0.4);
    }

    @media (max-width: 640px) {
        .timeline-dot {
            width: 40px; /* Smaller dot */
            height: 40px;
            font-size: 0.75rem;
            box-shadow: 0 0 0 4px rgba(203, 213, 225, 0.2); /* Smaller shadow ring */
        }

        .timeline-dot.active {
            box-shadow:
                0 0 0 4px var(--accent-light),
                0 0 12px rgba(10, 121, 200, 0.4);
        }
    }

    .timeline-line {
        width: 2px;
        flex: 1;
        background: var(--timeline-line);
        margin-top: 1rem;
        min-height: 60px;
    }

    .timeline-line-last {
        opacity: 0;
    }

    /* Timeline Content */
    .timeline-content {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 1.25rem;
        padding: 2rem 2.5rem;
        transition: all 0.3s ease;
    }

    @media (max-width: 640px) {
        .timeline-content {
            padding: 1.25rem; /* Reduced padding inside card */
            border-radius: 1rem;
        }
    }

    .timeline-content:hover {
        border-color: var(--accent);
        box-shadow: 0 4px 16px rgba(10, 121, 200, 0.1);
    }

    .timeline-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 0.75rem;
    }

    @media (max-width: 640px) {
        .timeline-title {
            font-size: 1.25rem;
        }
    }

    .timeline-desc {
        font-size: 1rem;
        color: var(--text-secondary);
        line-height: 1.7;
        margin: 0;
    }

    .text-accent {
        color: var(--accent);
        font-weight: 600;
    }

    /* Timeline CTA */
    .timeline-cta {
        display: flex;
        justify-content: center;
        margin-top: 3rem;
        opacity: 0;
        transform: translateY(20px);
    }
</style>

<script>
    import gsap from "gsap";

    function initProcessTimeline() {
        const section = document.getElementById("process-section");
        if (!section) return;

        const items = section.querySelectorAll(".timeline-item");
        const cta = section.querySelector(".timeline-cta");
        const dots = section.querySelectorAll(".timeline-dot");

        // Use IntersectionObserver for reliable viewport detection
        const observerOptions = {
            root: null,
            rootMargin: "0px 0px -25% 0px", // Trigger when 25% from the bottom
            threshold: 0,
        };

        // Observer for timeline items (fade in)
        const itemObserver = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    const item = entry.target as HTMLElement;
                    gsap.to(item, {
                        opacity: 1,
                        y: 0,
                        duration: 0.8,
                        ease: "power2.out",
                    });

                    // Animate the dot inside this item
                    const dot = item.querySelector(".timeline-dot");
                    if (dot) {
                        gsap.fromTo(
                            dot,
                            { scale: 0 },
                            {
                                scale: 1,
                                duration: 0.6,
                                ease: "back.out(1.7)",
                                onComplete: () => {
                                    // Add active class after scale animation
                                    dot.classList.add("active");
                                },
                            },
                        );
                    }

                    itemObserver.unobserve(item);
                }
            });
        }, observerOptions);

        // Observe all timeline items
        items.forEach((item) => {
            itemObserver.observe(item);
        });

        // Observer for CTA
        if (cta) {
            const ctaObserver = new IntersectionObserver(
                (entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            gsap.to(cta, {
                                opacity: 1,
                                y: 0,
                                duration: 0.8,
                                ease: "power2.out",
                            });
                            ctaObserver.unobserve(entry.target);
                        }
                    });
                },
                { root: null, rootMargin: "0px 0px -20% 0px", threshold: 0 },
            );
            ctaObserver.observe(cta);
        }
    }

    // Run on page load
    document.addEventListener("astro:page-load", initProcessTimeline);

    // Fallback for non-Astro navigation
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initProcessTimeline);
    } else {
        initProcessTimeline();
    }
</script>
