---
import { ViewTransitions } from "astro:transitions";

import "../styles/fonts.css";
import "../styles/global.css";
import Header from "../components/Header.astro";
import ServicesHeader from "../components/ServicesHeader.astro";
import Footer from "../components/Footer.astro";
import MobileStickyCTA from "../components/MobileStickyCTA.astro";
import SmoothScroll from "../components/SmoothScroll.astro";
import ClickBurst from "../components/ClickBurst.astro";
import Schema from "../components/SEO/Schema.astro";
import type { BrandConfig } from "../brands";
import { mobileTiresBrand } from "../brands";

const {
  title = "Queens Mobile Tires",
  description = "We come to you.",
  brand: propBrand,
  headerInverse = false,
  serviceData,
  faqData,
  forceDarkTheme = false,
  forceDarkHeader = false,
} = Astro.props;

// Use provided brand or default to mobile tires brand
const brand: BrandConfig = propBrand || mobileTiresBrand;

const currentPath = Astro.url.pathname;
const pathSegments = currentPath.split("/").filter(Boolean);

// Archive is just /services (1 segment)
const isServicesArchive =
  pathSegments.length === 1 && pathSegments[0] === "services";
// Category is /services/category (2 segments)
const isCategoryPage =
  pathSegments.length === 2 && pathSegments[0] === "services";
// Sub-page (individual service) is /services/category/service (3 segments)
const isServiceSubPage =
  pathSegments.length === 3 && pathSegments[0] === "services";

// Force regular header for archive and categories since they use standard bg-page
const useServicesHeader =
  (isServiceSubPage || forceDarkHeader) &&
  !isCategoryPage &&
  !isServicesArchive;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" href="/favicon.png" />

    <!-- Google Tag Manager -->
    <script is:inline>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-NJBHC4TP");
    </script>
    <!-- End Google Tag Manager -->

    <!-- Critical Font Preloads - Load these before CSS parsing -->
    <link
      rel="preload"
      href="/fonts/BigShoulders-VariableFont.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/InstrumentSans-Regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />

    <!-- Preconnect to external video host for Hero video -->
    <link rel="dns-prefetch" href="https://storage.googleapis.com" />
    <link rel="preconnect" href="https://storage.googleapis.com" crossorigin />

    <title>{title}</title>
    <Schema
      brand={brand}
      title={title}
      description={description}
      serviceData={serviceData}
      faqData={faqData}
    />
    <ViewTransitions />
    <script is:inline define:vars={{ forceDarkTheme }}>
      const applyTheme = () => {
        if (forceDarkTheme) {
          document.documentElement.classList.add("dark");
          document.documentElement.setAttribute("data-theme", "dark");
          return;
        }

        if (
          localStorage.getItem("color-theme") === "dark" ||
          (!("color-theme" in localStorage) &&
            window.matchMedia("(prefers-color-scheme: dark)").matches)
        ) {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }
      };

      // Apply on initial load
      applyTheme();

      // Re-apply after View Transitions swap
      document.addEventListener("astro:after-swap", applyTheme);
    </script>

    <!-- Always start fresh from top on page load -->
    <script is:inline>
      // Disable browser's automatic scroll restoration - always start at top
      if ("scrollRestoration" in history) {
        history.scrollRestoration = "manual";
      }
      // Scroll to top immediately
      window.scrollTo(0, 0);

      // GTM / View Transitions Compatibility
      // This tells GTM that a "page view" happened even when Astro swaps content
      document.addEventListener(
        "astro:page-load",
        () => {
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({
            event: "page_view",
            page_path: window.location.pathname,
            page_title: document.title,
          });
        },
        { once: false },
      );
    </script>
    <slot name="head" />
  </head>
  <body
    class="bg-page text-queens-primary flex flex-col min-h-screen w-full overflow-x-hidden dark:text-gray-100"
    class:list={[{ "theme-locked-bg": forceDarkTheme }]}
  >
    <!-- Google Tag Manager (noscript) -->
    <noscript
      ><iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-NJBHC4TP"
        height="0"
        width="0"
        style="display:none;visibility:hidden"></iframe></noscript
    >
    <!-- End Google Tag Manager (noscript) -->
    <a href="#main-content" class="skip-to-content-link">Skip to main content</a
    >

    {
      useServicesHeader ? (
        <ServicesHeader
          brand={brand}
          inverse={headerInverse || forceDarkHeader}
        />
      ) : (
        <Header brand={brand} inverse={headerInverse} />
      )
    }

    <main id="main-content" class="flex-grow">
      <slot />
    </main>

    <Footer brand={brand} />
    <SmoothScroll />
    <ClickBurst />
    {/* <MobileStickyCTA brand={brand} /> */}

    <!-- Global video autoplay fallback for Edge/browser compatibility -->
    <script is:inline>
      function forceAllVideosToPlay() {
        document.querySelectorAll("video").forEach(function (video) {
          if (video.paused && video.muted) {
            video.play().catch(function () {
              // Silent fail - browser policy blocks autoplay
            });
          }
        });
      }

      // Run on initial load
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", forceAllVideosToPlay);
      } else {
        forceAllVideosToPlay();
      }

      // Run after Astro view transitions
      document.addEventListener("astro:page-load", forceAllVideosToPlay);

      // Also run after a short delay in case videos load late
      setTimeout(forceAllVideosToPlay, 500);
    </script>
  </body>
</html>
